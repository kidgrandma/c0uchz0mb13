<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INTERNET OLYMPICS 2 - Admin Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #008080 url('../assets/finals/desktop-bg.jpg') center/cover;
            min-height: 100vh;
            padding: 20px;
        }

        /* Windows XP style windows */
        .window {
            background: #ece9d8;
            border: 2px solid #0054e3;
            border-radius: 6px 6px 0 0;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .window-header {
            background: linear-gradient(to bottom, #0054e3, #0041d0);
            color: white;
            padding: 3px 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px 4px 0 0;
        }

        .window-title {
            font-size: 13px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .window-controls {
            display: flex;
            gap: 2px;
        }

        .window-btn {
            width: 21px;
            height: 21px;
            border: 1px solid #fff;
            background: linear-gradient(to bottom, #fff, #e0e0e0);
            color: #000;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 2px;
        }

        .window-btn:hover {
            background: linear-gradient(to bottom, #e0e0e0, #ccc);
        }

        .window-content {
            padding: 15px;
            background: #fff;
            border: 1px solid #8b8b8b;
            margin: 3px;
        }

        /* Header stats */
        .stats-header {
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .stat-box {
            background: #f0f0f0;
            border: 2px solid #c0c0c0;
            border-bottom: 2px solid #808080;
            border-right: 2px solid #808080;
            padding: 10px;
            text-align: center;
        }

        .stat-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #000080;
        }

        /* Game cards */
        .game-card {
            background: #f0f0f0;
            border: 2px solid #c0c0c0;
            border-bottom: 2px solid #808080;
            border-right: 2px solid #808080;
            padding: 15px;
            margin-bottom: 15px;
        }

        .game-card:hover {
            background: #e8e8e8;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .game-code {
            font-size: 18px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            background: #000;
            color: #0f0;
            padding: 5px 10px;
            border: 1px solid #666;
        }

        .game-status {
            padding: 4px 12px;
            font-size: 11px;
            font-weight: bold;
            border: 1px solid;
            text-transform: uppercase;
        }

        .game-status.waiting {
            background: #fffacd;
            border-color: #daa520;
            color: #b8860b;
        }

        .game-status.playing {
            background: #90ee90;
            border-color: #228b22;
            color: #006400;
        }

        .game-status.finished {
            background: #ffcccb;
            border-color: #dc143c;
            color: #8b0000;
        }

        /* Players */
        .players-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .player-box {
            background: #fff;
            border: 1px solid #999;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-box.connected {
            background: #f0fff0;
            border-color: #228b22;
        }

        .player-box.current-turn {
            box-shadow: 0 0 0 2px #ff0;
            border-color: #ff0;
        }

        .player-avatar {
            width: 32px;
            height: 32px;
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-weight: bold;
            font-size: 13px;
        }

        .player-status {
            font-size: 11px;
            color: #666;
        }

        /* Game info */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .info-item {
            background: #fff;
            border: 1px solid #999;
            padding: 8px;
            text-align: center;
        }

        .info-label {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
        }

        .info-value {
            font-size: 16px;
            font-weight: bold;
            color: #000080;
        }

        /* Secret view */
        .secret-panel {
            background: #ffffcc;
            border: 2px solid #ff0000;
            padding: 10px;
            margin-bottom: 15px;
        }

        .secret-title {
            color: #ff0000;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .folder-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 2px;
            background: #000;
            padding: 2px;
            border: 1px solid #666;
        }

        .grid-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            background: #fff;
            border: 1px solid #ccc;
        }

        .grid-cell.bsod {
            background: #ccccff;
            border-color: #0000ff;
        }

        .grid-cell.virus {
            background: #ffcccc;
            border-color: #ff0000;
        }

        .grid-cell.antivirus {
            background: #ccffcc;
            border-color: #00cc00;
        }

        .grid-cell.safe {
            background: #f0f0f0;
        }

        .grid-cell.empty {
            background: #333;
            opacity: 0.3;
        }

        /* Actions */
        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            background: #ece9d8;
            border: 2px solid #c0c0c0;
            border-bottom: 2px solid #808080;
            border-right: 2px solid #808080;
            padding: 5px 15px;
            font-family: Arial, sans-serif;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.1s;
        }

        .btn:hover {
            background: #e0e0e0;
        }

        .btn:active {
            border: 2px solid #808080;
            border-bottom: 2px solid #c0c0c0;
            border-right: 2px solid #c0c0c0;
        }

        .btn.danger {
            background: #ffcccc;
            color: #800000;
        }

        .btn.danger:hover {
            background: #ff9999;
        }

        /* No games message */
        .no-games {
            text-align: center;
            padding: 100px 20px;
            font-size: 16px;
            color: #666;
            background: #f0f0f0;
            border: 2px dashed #c0c0c0;
        }

        /* Refresh button */
        .refresh-float {
            position: fixed;
            bottom: 20px;
            right: 20px;
        }

        /* Mobile adjustments */
        @media (max-width: 768px) {
            .players-row {
                grid-template-columns: 1fr;
            }
            
            .folder-grid {
                grid-template-columns: repeat(6, 1fr);
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Main stats window -->
    <div class="window">
        <div class="window-header">
            <div class="window-title">
                📊 INTERNET OLYMPICS 2 - Admin Control Panel
            </div>
            <div class="window-controls">
                <button class="window-btn">_</button>
                <button class="window-btn">□</button>
                <button class="window-btn">×</button>
            </div>
        </div>
        <div class="window-content">
            <div class="stats-header">
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">ACTIVE GAMES</div>
                        <div class="stat-value" id="activeGames">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">TOTAL PLAYERS</div>
                        <div class="stat-value" id="totalPlayers">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">SPECTATORS</div>
                        <div class="stat-value" id="totalSpectators">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">GAMES TODAY</div>
                        <div class="stat-value" id="gamesToday">0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Games list -->
    <div id="gamesContainer">
        <div class="window">
            <div class="window-header">
                <div class="window-title">🎮 Active Games</div>
                <div class="window-controls">
                    <button class="window-btn">_</button>
                    <button class="window-btn">□</button>
                    <button class="window-btn">×</button>
                </div>
            </div>
            <div class="window-content">
                <div class="no-games">
                    <div style="font-size: 48px; margin-bottom: 20px;">📁</div>
                    <div>NO ACTIVE GAMES</div>
                    <div style="font-size: 12px; color: #999; margin-top: 10px;">Games will appear here when players create them</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Game Window -->
    <div class="window" style="max-width: 500px; margin: 20px auto;">
        <div class="window-header">
            <div class="window-title">🎯 Create Game for Players</div>
            <div class="window-controls">
                <button class="window-btn">_</button>
                <button class="window-btn">□</button>
                <button class="window-btn">×</button>
            </div>
        </div>
        <div class="window-content">
            <div style="text-align: center;">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: bold;">Game Code (6 characters):</label>
                    <input type="text" id="customGameCode" placeholder="GAME01" maxlength="6" style="padding: 8px; font-size: 18px; text-transform: uppercase; width: 200px; text-align: center; font-family: 'Courier New', monospace;">
                </div>
                <button class="btn" onclick="createCustomGame()" style="padding: 10px 30px; font-size: 14px;">
                    🎮 CREATE GAME
                </button>
                <div id="createResult" style="margin-top: 20px; font-size: 14px;"></div>
            </div>
        </div>
    </div>

    <div class="refresh-float">
        <button class="btn" onclick="location.reload()">
            🔄 REFRESH
        </button>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            query, 
            where, 
            onSnapshot,
            doc,
            updateDoc,
            deleteDoc,
            getDocs,
            setDoc,
            serverTimestamp,
            getDoc
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDJ8uiR2qEUfXIuFEO2l-40668WNpQdj2w",
            authDomain: "c0uchz0mb13.firebaseapp.com",
            projectId: "c0uchz0mb13",
            storageBucket: "c0uchz0mb13.firebasestorage.app",
            messagingSenderId: "1051521591004",
            appId: "1:1051521591004:web:1301f129fc0f3032f6f619",
            measurementId: "G-6BNDYZQRPE"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // UI Elements
        const elements = {
            gamesContainer: document.getElementById('gamesContainer'),
            activeGames: document.getElementById('activeGames'),
            totalPlayers: document.getElementById('totalPlayers'),
            totalSpectators: document.getElementById('totalSpectators'),
            gamesToday: document.getElementById('gamesToday')
        };

        // Track all games
        let allGames = [];

        // Create game card
        function createGameCard(gameId, gameData) {
            const window = document.createElement('div');
            window.className = 'window';
            window.style.marginBottom = '20px';
            
            const statusClass = gameData.status;
            const currentTurn = gameData.currentTurn || '-';
            
            window.innerHTML = `
                <div class="window-header">
                    <div class="window-title">🎮 Game: ${gameId}</div>
                    <div class="window-controls">
                        <button class="window-btn">_</button>
                        <button class="window-btn">□</button>
                        <button class="window-btn">×</button>
                    </div>
                </div>
                <div class="window-content">
                    <div class="game-card">
                        <div class="game-header">
                            <div class="game-code">${gameId}</div>
                            <div class="game-status ${statusClass}">${gameData.status}</div>
                        </div>
                        
                        <div class="players-row">
                            <div class="player-box ${gameData.players?.player1?.connected ? 'connected' : ''} ${currentTurn === 1 ? 'current-turn' : ''}">
                                <img src="../assets/finals/angelbubu-1.png" class="player-avatar">
                                <div class="player-info">
                                    <div class="player-name">${gameData.players?.player1?.name || 'Empty Slot'}</div>
                                    <div class="player-status">${gameData.players?.player1?.connected ? 'Connected' : 'Waiting...'}</div>
                                </div>
                            </div>
                            <div class="player-box ${gameData.players?.player2?.connected ? 'connected' : ''} ${currentTurn === 2 ? 'current-turn' : ''}">
                                <img src="../assets/finals/angelbubu-2.png" class="player-avatar">
                                <div class="player-info">
                                    <div class="player-name">${gameData.players?.player2?.name || 'Empty Slot'}</div>
                                    <div class="player-status">${gameData.players?.player2?.connected ? 'Connected' : 'Waiting...'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">Folders</div>
                                <div class="info-value">${gameData.folderCount || 60}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Viewers</div>
                                <div class="info-value">${gameData.spectators || 0}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Turn</div>
                                <div class="info-value">${gameData.status === 'playing' ? currentTurn : '-'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Started</div>
                                <div class="info-value">${gameData.createdAt ? new Date(gameData.createdAt.seconds * 1000).toLocaleTimeString() : '-'}</div>
                            </div>
                        </div>
                        
                        ${gameData.status === 'playing' ? createSecretPanel(gameData) : ''}
                        
                        <div class="actions">
                            <button class="btn" onclick="window.open('./spectator.html?game=${gameId}', '_blank')">
                                👁️ SPECTATE
                            </button>
                            ${gameData.status !== 'finished' ? `
                                <button class="btn danger" onclick="endGame('${gameId}')">
                                    ⏹️ END GAME
                                </button>
                            ` : ''}
                            <button class="btn danger" onclick="deleteGame('${gameId}')">
                                🗑️ DELETE
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            return window;
        }

        // Create secret panel showing folder types
        function createSecretPanel(gameData) {
            if (!gameData.folders) return '';
            
            let html = '<div class="secret-panel"><div class="secret-title">⚠️ SECRET: Folder Contents</div><div class="folder-grid">';
            
            // Show exactly 60 folders in 10x6 grid
            for (let i = 0; i < 60; i++) {
                const folder = gameData.folders[i];
                if (folder && folder.visible) {
                    const typeClass = folder.type;
                    const typeSymbol = folder.type === 'bsod' ? '💀' : 
                                     folder.type === 'virus' ? '🦠' : 
                                     folder.type === 'antivirus' ? '🛡️' : '📁';
                    html += `<div class="grid-cell ${typeClass}">${typeSymbol}</div>`;
                } else {
                    html += '<div class="grid-cell empty">·</div>';
                }
            }
            
            html += '</div></div>';
            return html;
        }

        // Update global stats
        function updateStats() {
            const activeGames = allGames.filter(g => g.status !== 'finished').length;
            const totalPlayers = allGames.reduce((sum, g) => {
                return sum + (g.players?.player1?.connected ? 1 : 0) + (g.players?.player2?.connected ? 1 : 0);
            }, 0);
            const totalSpectators = allGames.reduce((sum, g) => sum + (g.spectators || 0), 0);
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const gamesToday = allGames.filter(g => {
                if (g.createdAt && g.createdAt.seconds) {
                    const gameDate = new Date(g.createdAt.seconds * 1000);
                    return gameDate >= today;
                }
                return false;
            }).length;
            
            elements.activeGames.textContent = activeGames;
            elements.totalPlayers.textContent = totalPlayers;
            elements.totalSpectators.textContent = totalSpectators;
            elements.gamesToday.textContent = gamesToday;
        }

        // Global functions for buttons
        window.endGame = async (gameId) => {
            if (confirm(`End game ${gameId}?\n\nThis will stop the game without declaring a winner.`)) {
                await updateDoc(doc(db, 'games', gameId), {
                    status: 'finished',
                    winner: null
                });
            }
        };

        window.deleteGame = async (gameId) => {
            if (confirm(`Delete game ${gameId}?\n\nThis action cannot be undone!`)) {
                await deleteDoc(doc(db, 'games', gameId));
            }
        };

        // Listen to all games
        const gamesRef = collection(db, 'games');
        const unsubscribe = onSnapshot(gamesRef, (snapshot) => {
            allGames = [];
            
            snapshot.forEach((doc) => {
                allGames.push({ id: doc.id, ...doc.data() });
            });
            
            // Sort by creation time (newest first)
            allGames.sort((a, b) => {
                const aTime = a.createdAt?.seconds || 0;
                const bTime = b.createdAt?.seconds || 0;
                return bTime - aTime;
            });
            
            // Update UI
            if (allGames.length === 0) {
                elements.gamesContainer.innerHTML = `
                    <div class="window">
                        <div class="window-header">
                            <div class="window-title">🎮 Active Games</div>
                            <div class="window-controls">
                                <button class="window-btn">_</button>
                                <button class="window-btn">□</button>
                                <button class="window-btn">×</button>
                            </div>
                        </div>
                        <div class="window-content">
                            <div class="no-games">
                                <div style="font-size: 48px; margin-bottom: 20px;">📁</div>
                                <div>NO ACTIVE GAMES</div>
                                <div style="font-size: 12px; color: #999; margin-top: 10px;">Games will appear here when players create them</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                elements.gamesContainer.innerHTML = '';
                allGames.forEach(game => {
                    elements.gamesContainer.appendChild(createGameCard(game.id, game));
                });
            }
            
            updateStats();
        });

        // Create custom game function
        window.createCustomGame = async function() {
            const customCode = document.getElementById('customGameCode').value.trim().toUpperCase();
            const resultEl = document.getElementById('createResult');
            
            if (!customCode || customCode.length !== 6) {
                resultEl.innerHTML = '<span style="color: red;">Please enter a 6-character code</span>';
                return;
            }
            
            // Check if code already exists
            const gameRef = doc(db, 'games', customCode);
            const existingGame = await getDoc(gameRef);
            
            if (existingGame.exists()) {
                resultEl.innerHTML = '<span style="color: red;">This code already exists!</span>';
                return;
            }
            
            try {
                // Generate 60 folders
                const folders = [];
                for (let i = 0; i < 60; i++) {
                    folders.push({
                        id: i,
                        icon: `icon-${Math.floor(Math.random() * 30) + 1}`,
                        visible: true,
                        type: 'safe'
                    });
                }
                
                // Place 1 BSOD randomly
                const bsodIndex = Math.floor(Math.random() * 60);
                folders[bsodIndex].type = 'bsod';
                
                // Place 8-10 viruses
                const virusCount = Math.floor(Math.random() * 3) + 8;
                const usedIndices = [bsodIndex];
                
                for (let i = 0; i < virusCount; i++) {
                    let virusIndex;
                    do {
                        virusIndex = Math.floor(Math.random() * 60);
                    } while (usedIndices.includes(virusIndex));
                    
                    folders[virusIndex].type = 'virus';
                    usedIndices.push(virusIndex);
                }
                
                // Place 1-2 antivirus
                const antivirusCount = Math.floor(Math.random() * 2) + 1;
                for (let i = 0; i < antivirusCount; i++) {
                    let antivirusIndex;
                    do {
                        antivirusIndex = Math.floor(Math.random() * 60);
                    } while (usedIndices.includes(antivirusIndex));
                    
                    folders[antivirusIndex].type = 'antivirus';
                    usedIndices.push(antivirusIndex);
                }
                
                // Create game
                const gameData = {
                    status: 'waiting',
                    players: {
                        player1: {
                            name: '',
                            avatar: '',
                            connected: false,
                            joinedAt: null,
                            immunityClicks: 0
                        },
                        player2: {
                            name: '',
                            avatar: '',
                            connected: false,
                            joinedAt: null,
                            immunityClicks: 0
                        }
                    },
                    currentTurn: 1,
                    folders: folders,
                    folderCount: 60,
                    lastAction: {
                        type: '',
                        player: 0,
                        folderId: 0,
                        timestamp: null,
                        result: '',
                        virusAte: []
                    },
                    virusActive: false,
                    spectators: 0,
                    createdAt: serverTimestamp(),
                    createdBy: 'admin',
                    winner: null,
                    gameEvents: []
                };
                
                await setDoc(gameRef, gameData);
                
                resultEl.innerHTML = `
                    <div style="color: green; font-weight: bold; margin-bottom: 10px;">✅ Game created successfully!</div>
                    <div style="background: #f0f0f0; padding: 10px; border: 1px solid #999;">
                        <div style="margin-bottom: 5px;">Share this in chat:</div>
                        <div style="background: #000; color: #0f0; padding: 10px; font-family: 'Courier New', monospace; font-size: 16px;">
                            Join game with code: ${customCode}
                        </div>
                    </div>
                `;
                
                // Clear input
                document.getElementById('customGameCode').value = '';
                
            } catch (error) {
                console.error('Error creating game:', error);
                resultEl.innerHTML = '<span style="color: red;">Failed to create game. Try again.</span>';
            }
        };
        
        // Auto-uppercase input
        document.getElementById('customGameCode').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });

        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (unsubscribe) unsubscribe();
        });
    </script>
</body>
</html>